<!-- <!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dog Breed ID</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
</head>
<body>
    <div class="intro">
        <div class="overlay">
            <div class="contents">
                <h1>Welcome to Dog Breed ID</h1>
                <p>
                    Looking to uncover your furry friend's breed? <br>
                    Upload a photo, and let us do the rest!
                </p>

                <form id="upload-form" method="POST" enctype="multipart/form-data" action="/predict">
                    <input id="file-input" type="file" name="file" style="display:none;" onchange="showPredictButton();">

                    <div class="button">
                        <button class="upload-button" type="button" onclick="document.getElementById('file-input').click();">Upload a Photo</button>
                        <button id="predict-button" class="predict-button" type="submit" style="display:none;">Predict</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        function showPredictButton() {
            document.getElementById('predict-button').style.display = 'inline-block';
        }
    </script>
</body>
</html> -->


<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dog Breed ID</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
</head>
<body>
    <div class="intro">
        <div class="overlay">
            <div class="contents"> 
                <h1>Welcome to Dog Breed ID</h1>
                <p>
                    Looking to uncover your furry friend's breed? <br>
                    Upload a photo, and let us do the rest!
                </p>

                <form id="upload-form" method="POST" enctype="multipart/form-data">
                    <input id="file-input" type="file" name="file" style="display:none;" onchange="uploadToCloudinary(this)">

                    <div class="buttons">
                        <button class="upload-button" type="button" onclick="document.getElementById('file-input').click();">Upload a Photo</button>
                        <button id="predict-button" class="predict-button" type="button" style="display:none;" onclick="sendToFlask()">Predict</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        let uploadedFileUrl = ''; //Store uploaded file

        const cloudName = 'dycjsp8iy';  //Changing name of uploaded image
        const uploadPreset = 'Dog Breed Classifier';  //Setting cloudinary upload preset

        function uploadToCloudinary(input) {
            const file = input.files[0]; //preparing input image
            const formData = new FormData(); 
            formData.append('file', file);
            formData.append('upload_preset', uploadPreset);

            fetch(`https://api.cloudinary.com/v1_1/${cloudName}/image/upload`, { //sending image to cloudinary
                method: 'POST',
                body: formData
            }) 
            .then(response => response.json())
            .then(data => {
                uploadedFileUrl = data.secure_url; //Receiving image from cloudinary
                console.log('File uploaded:', uploadedFileUrl);
                document.getElementById('predict-button').style.display = 'inline-block'; //Display predict button once file is uploaded
            })
            .catch(err => console.error('Upload error:', err)); //error message
        }

        async function sendToFlask() {
            try {
                const response = await fetch('/predict', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }, //Checks whether content is JSON
                    body: JSON.stringify({ image_url: uploadedFileUrl }), //Converts to JSON string
                })

                if (!response.ok) throw new Error(`Server returned status: ${response.status}`) //Check status

                const data = await response.json()
                console.log('Prediction response from Flask:', data)

                //Obtaining results to display
                const imageUrl = encodeURIComponent(data.image_url)
                const breed = encodeURIComponent(data.breed)
                const confidence = encodeURIComponent(data.confidence)
                const breedDetails = encodeURIComponent(JSON.stringify(data.breed_details))

                //Once all processes are complete, redirect to results page
                window.location.href = `/results?image_url=${imageUrl}&breed=${breed}&confidence=${confidence}&breed_details=${breedDetails}`
            } catch (error) { //final check for errors
                console.error('Error sending image URL to Flask:', error)
                alert('Sorry, there was an error processing your request. Please try again later.')
            }
        }



        // function sendToFlask() {
        //     fetch('/predict', {
        //         method: 'POST',
        //         headers: {
        //             'Content-Type': 'application/json'
        //         },
        //         body: JSON.stringify({ image_url: uploadedFileUrl })
        //     })
        //     .then(response => response.json())
        //     .then(data => {
        //         console.log('Prediction response from Flask:', data);
        //         window.location.href = `/results?image_url=${encodeURIComponent(data.image_url)}&breed=${encodeURIComponent(data.breed)}&confidence=${encodeURIComponent(data.confidence)}`;
        //     })
        //     .catch(err => console.error('Error sending image URL to Flask:', err));
        // }
    </script>
</body>
</html>
